<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${movie.title}">영화 상세</title>

    <!-- Film Box 공통 헤더 스타일/동작 -->
    <link rel="stylesheet" href="/Member/css/index.css">
    <script th:src="@{/Member/js/index.js}" defer></script>

    <!-- DetailpageReserve 전용 CSS (index.css보다 나중에 로드해서 화면 충돌 최소화) -->
    <link rel="stylesheet" th:href="@{/DetailpageReserve/css/style.css}"/>

    <!-- detail.html 전용 스타일 -->
    <style>  
	    /* 페이지 전체 여백용 컨테이너 */
	    .detail-layout {
	        max-width: 1200px;   /* 내용 최대 너비 */
	        margin: 0 auto;      /* 좌우 가운데 정렬 (브라우저 양 옆 여백 생김) */
	        padding: 0 40px;     /* 내용과 컨테이너 사이의 좌우 여백 */
	    }
        /* 상단 '영화 목록으로' 링크 */
        a.back-to-list {
            display: inline-block;
            margin: 10px 0 20px;
            font-size: 24px;      /* 글자 크게 */
            font-weight: 700;     /* 굵게 */
            color: #333;
            text-decoration: none;
        }

        a.back-to-list:hover {
            text-decoration: underline;
        }

        /* 이하 기존 스타일들 */

        .screening-section {
            margin-top: 30px;
        }

        .screening-filters {
            border: 1px solid #ddd;
            padding: 12px 16px;
            margin-bottom: 16px;
            background: #fafafa;
        }

        .screening-filters .filter-row {
            margin-bottom: 8px;
        }

        .screening-filters .filter-label {
            display: inline-block;
            width: 90px;
            font-weight: bold;
        }

        .screening-filters .brand-filter {
            margin-right: 6px;
            padding: 4px 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            border-radius: 3px;
            font-size: 13px;
        }

        .screening-filters .brand-filter.active {
            background: #333;
            color: #fff;
            border-color: #333;
        }

        .screening-filters select {
            padding: 3px 6px;
            font-size: 13px;
        }

        .screening-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        .screening-table th,
        .screening-table td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            font-size: 13px;
        }

        .screening-table th {
            background: #f4f4f4;
        }

        .reserve-link {
            display: inline-block;
            padding: 4px 10px;
            background: #0080ff;
            color: #fff;
            border-radius: 3px;
            text-decoration: none;
            font-size: 12px;
        }

        .soldout-text {
            color: #999;
            font-size: 12px;
        }

        .movie-container {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .poster-wrapper img.movie-poster {
            width: 250px;
        }
    </style>
</head>
<body>

<!-- Film Box 공통 헤더 -->
<div th:replace="fragments/header :: header('movies')"></div>

<main class="detail-layout">
    <!-- 상단 뒤로가기 링크 -->
    <a th:href="@{/movies}" class="back-to-list">&lt; 영화 목록으로</a>

<h1 th:text="${movie.title}" class="movie-title">영화 제목</h1>

<!-- ===== 영화 기본 정보 ===== -->
<div class="movie-container">

    <!-- 포스터 영역 -->
    <div class="poster-wrapper">
        <!-- DB 값: /DetailpageReserve/img/xxx.webp -->
        <img th:src="${movie.posterUrl}"
             alt="포스터"
             class="movie-poster"/>
    </div>

    <!-- 정보/줄거리 영역 -->
    <div class="movie-info">
        <p class="movie-meta">
            장르:
            <span th:text="${movie.genre}">액션</span><br/>
            상영시간:
            <span th:text="${movie.runningTime}">120분</span><br/>
            등급:
            <span th:text="${movie.rating}">15세이상</span>
        </p>

        <p class="movie-description"
           th:text="${movie.description}">
            영화 줄거리 텍스트
        </p>
    </div>
    </div>

<!-- ===== 예고편 / 관련 영상 ===== -->
<section class="trailer-section"
         th:if="${trailerIds != null and !#lists.isEmpty(trailerIds)}">
    <h2>예고편 / 관련 영상</h2>
    <div class="trailer-list">
        <div th:each="tid : ${trailerIds}"
             class="trailer-item"
             style="display:inline-block;margin-right:10px;">
            <iframe th:src="'https://www.youtube.com/embed/' + ${tid}"
                    width="260"
                    height="160"
                    frameborder="0"
                    allowfullscreen>
            </iframe>
        </div>
    </div>
</section>

<!-- ===== 상영 정보 + 필터 ===== -->
<section class="screening-section">
    <h2>상영 정보</h2>

    <!-- 필터 박스 (상영 일정 있을 때만) -->
    <div class="screening-filters" th:if="${!#lists.isEmpty(screenings)}">
        <div class="filter-row">
            <span class="filter-label">영화관 선택</span>
            <button type="button" class="brand-filter active" data-brand="ALL">전체</button>
            <button type="button" class="brand-filter" data-brand="CGV">CGV</button>
            <button type="button" class="brand-filter" data-brand="롯데시네마">롯데시네마</button>
            <button type="button" class="brand-filter" data-brand="메가박스">메가박스</button>
        </div>
        <div class="filter-row">
            <span class="filter-label">지점 / 위치 선택</span>
            <select id="branchSelect">
                <option value="ALL">전체 지점</option>
                <!-- 옵션은 아래 JS가 상영관 목록에서 자동 생성 -->
            </select>
        </div>
    </div>

    <!-- 상영 일정 없을 때 -->
    <div class="no-screening" th:if="${#lists.isEmpty(screenings)}">
        등록된 상영 일정이 없습니다.
    </div>

    <!-- 상영 일정 테이블 (있을 때) -->
    <div th:unless="${#lists.isEmpty(screenings)}">
        <table class="screening-table">
            <thead>
            <tr>
                <th>극장</th>
                <th>상영 시간</th>
                <th>잔여 좌석</th>
                <th>예매</th>
            </tr>
            </thead>
            <tbody id="screeningTableBody">
            <tr th:each="screening : ${screenings}"
                th:attr="data-theater=${screening.theaterName}">
                <td th:text="${screening.theaterName}">CGV 강남점</td>
                <td th:text="${#temporals.format(screening.screeningTime, 'yyyy-MM-dd HH:mm')}">
                    2026-01-01 12:00
                </td>
                <td>
                    <span th:text="${availableSeatsMap[screening.id]}">0</span>
                    /
                    <span th:text="${screening.totalSeats}">100</span>
                </td>
                <td>
                    <a th:if="${availableSeatsMap[screening.id] > 0}"
                       th:href="@{|/reserve/${screening.id}|}"
                       class="reserve-link">
                        예매하기
                    </a>
                    <span th:if="${availableSeatsMap[screening.id] <= 0}"
                          class="soldout-text">
                        매진
                    </span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

    <!-- 아래 여백 -->
    <div style="height: 80px;"></div>
</main>

<!-- ===== 상영 정보 필터 JS ===== -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rows = Array.from(document.querySelectorAll('#screeningTableBody tr'));
        const branchSelect = document.getElementById('branchSelect');
        const brandButtons = Array.from(document.querySelectorAll('.brand-filter'));

        if (!rows.length) {
            return;
        }

        // 지점 목록 중복 제거해서 select option 만들기
        const branchSet = new Set();
        rows.forEach(row => {
            const theater = row.dataset.theater || '';
            if (theater) {
                branchSet.add(theater);
            }
        });
        branchSet.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            branchSelect.appendChild(opt);
        });

        let currentBrand = 'ALL';
        let currentBranch = 'ALL';

        function applyFilter() {
            rows.forEach(row => {
                const theater = row.dataset.theater || '';

                // 브랜드는 극장 이름에 포함되는지만 체크 (CGV / 롯데시네마 / 메가박스)
                const brandMatch =
                    currentBrand === 'ALL' ||
                    theater.indexOf(currentBrand) !== -1;

                const branchMatch =
                    currentBranch === 'ALL' ||
                    theater === currentBranch;

                row.style.display = (brandMatch && branchMatch) ? '' : 'none';
            });
        }

        brandButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                brandButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentBrand = btn.dataset.brand;
                applyFilter();
            });
        });

        branchSelect.addEventListener('change', () => {	
            currentBranch = branchSelect.value;
            applyFilter();
        });
    });
</script>

</body>
</html>
