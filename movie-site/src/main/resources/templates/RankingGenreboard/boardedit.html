<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê²Œì‹œê¸€ ìˆ˜ì •</title>

  <link rel="stylesheet" href="/RankingGenreboard/css/app.css" />
  <link rel="stylesheet" href="/Member/css/index.css" />
  <script th:src="@{/Member/js/index.js}" defer></script>

  <style>
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid rgba(255,255,255,.12); border-radius: 14px; padding: 18px; background: rgba(255,255,255,.04); }
    .h1 { font-size: 22px; font-weight: 900; margin: 0 0 14px; }

    label { display:block; font-weight: 800; margin: 14px 0 8px; }
    input[type="text"], textarea {
      width: 100%; box-sizing: border-box;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.14);
      color:#e5e7eb;
      border-radius: 10px;
      padding: 12px 14px;
      outline: none;
    }
    textarea { min-height: 240px; resize: vertical; }

    .hint { margin-top: 8px; opacity: .85; font-size: 13px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top: 16px; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 14px; border-radius: 10px;
      border:1px solid rgba(255,255,255,.18);
      text-decoration:none; color:#fff;
      background: rgba(255,255,255,.06);
      font-weight: 800;
      cursor:pointer;
    }
    .btn:hover { background: rgba(255,255,255,.10); }
    .btn-primary { background:#111827; border-color:#1f2937; }
    .btn-primary:hover { background:#0b1220; }

    .section { margin-top: 18px; padding-top: 14px; border-top: 1px solid rgba(255,255,255,.10); }
    .section h3 { margin: 0 0 10px; font-size: 16px; font-weight: 900; }

    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
    .img-card { border: 1px solid rgba(255,255,255,.12); border-radius: 14px; overflow: hidden; background: rgba(255,255,255,.06); }
    .img-card img { width: 100%; height: 140px; object-fit: cover; display:block; }
    .img-card .meta { padding: 10px; display:flex; flex-direction: column; gap: 8px; }
    .img-card .name { font-size: 12px; color: rgba(255,255,255,.75); white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }
    .chk { display:flex; align-items:center; gap: 8px; font-size: 13px; }
    .chk input { width: 16px; height: 16px; }

    .preview-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-top: 10px; }
    .thumb { position:relative; border-radius: 14px; overflow:hidden; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); }
    .thumb img { width:100%; height:140px; object-fit:cover; display:block; }
    .thumb .meta { padding: 8px 10px; font-size: 12px; color: rgba(255,255,255,.78); white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }
    .thumb .remove {
      position:absolute; top:8px; right:8px;
      padding: 6px 8px; border-radius: 999px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.18);
      font-size: 12px; font-weight: 900;
    }

    .error { margin-top: 12px; color:#fecaca; font-size: 13px; white-space: pre-line; display:none; }
    .stat { margin-top: 10px; font-size: 13px; color: rgba(255,255,255,.78); }
    .pill { display:inline-block; padding: 3px 10px; border-radius: 999px; border:1px solid rgba(255,255,255,.16); background: rgba(255,255,255,.06); }
  </style>
</head>

<body>
<header class="header">
  <div class="header-inner">
    <a href="/" class="logo">
      <div class="logo-mark">FB</div>
      Film Box
    </a>

    <nav class="main-nav">
      <a href="/">í™ˆ</a>
      <a href="/movies">ì˜í™”/ì˜ˆë§¤</a>
      <a href="/ranking">í¥í–‰ì˜í™”ìˆœìœ„</a>
      <a href="/genre">ì¥ë¥´</a>
      <a href="/board" class="active">ê²Œì‹œíŒ</a>
    </nav>

    <div class="auth-nav">
      <a href="/login" data-role="login">ë¡œê·¸ì¸</a>
      <a href="/signup" data-role="signup">íšŒì›ê°€ì…</a>
      <a href="/mypage" data-role="mypage" style="display:none;">ë§ˆì´í˜ì´ì§€</a>
      <a href="#" data-role="logout" style="display:none;">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="h1">ê²Œì‹œê¸€ ìˆ˜ì •</div>

    <form id="editForm"
          th:action="@{/board/{id}/edit(id=${postId}, page=${backPage})}"
          method="post"
          enctype="multipart/form-data">

      <input type="hidden"
             th:if="${_csrf != null}"
             th:name="${_csrf.parameterName}"
             th:value="${_csrf.token}" />

      <label for="title">ì œëª©</label>
      <input id="title" name="title" type="text" maxlength="200" required
             th:value="${form.title}" />

      <label for="content">ë‚´ìš©</label>
      <textarea id="content" name="content" required
                th:text="${form.content}"></textarea>

      <div class="section">
        <h3>ê¸°ì¡´ ì´ë¯¸ì§€</h3>

        <div th:if="${images == null or #lists.isEmpty(images)}" class="hint">
          ê¸°ì¡´ ì²¨ë¶€ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>

        <div class="grid" th:if="${images != null and !#lists.isEmpty(images)}">
          <div class="img-card" th:each="img : ${images}">
            <a th:href="${img.url}" target="_blank" rel="noopener">
              <img th:src="${img.url}" th:alt="${img.originalName}" loading="lazy" />
            </a>
            <div class="meta">
              <div class="name" th:text="${img.originalName}">file</div>
              <label class="chk">
                <input type="checkbox" name="deleteImageIds" th:value="${img.id}" class="delChk" />
                <span>ì´ ì´ë¯¸ì§€ ì‚­ì œ</span>
              </label>
            </div>
          </div>
        </div>

        <div class="stat">
          <span class="pill">ìµœëŒ€ 5ì¥</span>
          <span style="margin-left:8px;" id="existingStat" class="pill"
                th:text="'í˜„ì¬ ' + (${images == null ? 0 : #lists.size(images)}) + 'ì¥'">í˜„ì¬ 0ì¥</span>
          <span style="margin-left:8px;" id="deleteStat" class="pill">ì‚­ì œ ì„ íƒ 0ì¥</span>
          <span style="margin-left:8px;" id="remainSlot" class="pill">ì¶”ê°€ ê°€ëŠ¥ 5ì¥</span>
        </div>
      </div>

      <div class="section">
        <h3>ì‹ ê·œ ì´ë¯¸ì§€ ì¶”ê°€</h3>
        <div class="hint">ì¥ë‹¹ 5MB ì´í•˜ Â· jpg/png/webp/gif/avif Â· ì¶”ê°€ ì—…ë¡œë“œëŠ” â€œë‚¨ì€ ìŠ¬ë¡¯â€ë§Œí¼ë§Œ ì €ì¥ë¼ìš” ğŸ™‚</div>

        <input id="images" name="images" type="file" multiple
               accept=".jpg,.jpeg,.png,.webp,.gif,.avif,image/avif,image/*"
               style="display:none" />

        <div class="row">
          <button class="btn" type="button" id="addBtn">ì´ë¯¸ì§€ ì¶”ê°€</button>
          <button class="btn btn-primary" type="submit">ì €ì¥</button>
          <a class="btn" th:href="@{/board/{id}(id=${postId}, page=${backPage})}">ì·¨ì†Œ</a>
        </div>

        <div id="errorBox" class="error"></div>
        <div class="preview-grid" id="previewGrid"></div>
      </div>

    </form>
  </div>
</div>

<script>
  (function () {
    const MAX_TOTAL = 5;
    const MAX_SIZE = 5 * 1024 * 1024;

    const addBtn = document.getElementById('addBtn');
    const fileInput = document.getElementById('images');
    const previewGrid = document.getElementById('previewGrid');
    const errorBox = document.getElementById('errorBox');

    const delChks = Array.from(document.querySelectorAll('.delChk'));
    const existingCount = delChks.length;

    const deleteStat = document.getElementById('deleteStat');
    const remainSlot = document.getElementById('remainSlot');

    const dt = new DataTransfer();

    function showError(msg) {
      if (!msg) { errorBox.style.display = 'none'; errorBox.textContent = ''; return; }
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
    }

    function keyOf(file) { return `${file.name}__${file.size}__${file.lastModified}`; }
    function currentKeys() { const s = new Set(); for (const f of dt.files) s.add(keyOf(f)); return s; }
    function safeExtOk(name) { return /\.(jpg|jpeg|png|webp|gif|avif)$/i.test(name || ''); }

    function isAllowedImage(file) {
      const type = (file.type || '').toLowerCase();
      const name = (file.name || '').toLowerCase();
      return type.startsWith('image/') || safeExtOk(name);
    }

    function deletedCount() { return delChks.filter(c => c.checked).length; }
    function remainingSlots() {
      const remainExisting = existingCount - deletedCount();
      return Math.max(0, MAX_TOTAL - remainExisting);
    }

    function refreshStats() {
      deleteStat.textContent = `ì‚­ì œ ì„ íƒ ${deletedCount()}ì¥`;
      remainSlot.textContent = `ì¶”ê°€ ê°€ëŠ¥ ${remainingSlots()}ì¥`;
    }

    function renderPreview() {
      previewGrid.innerHTML = '';
      const files = Array.from(dt.files || []);
      if (files.length === 0) return;

      files.forEach((file, idx) => {
        const div = document.createElement('div');
        div.className = 'thumb';

        const img = document.createElement('img');
        const url = URL.createObjectURL(file);
        img.src = url;
        img.onload = () => URL.revokeObjectURL(url);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${idx + 1}. ${file.name}`;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove';
        removeBtn.textContent = 'âœ•';
        removeBtn.addEventListener('click', () => {
          const next = new DataTransfer();
          Array.from(dt.files).forEach((f, i) => { if (i !== idx) next.items.add(f); });
          while (dt.items.length) dt.items.remove(0);
          Array.from(next.files).forEach(f => dt.items.add(f));
          fileInput.files = dt.files;
          renderPreview();
        });

        div.appendChild(img);
        div.appendChild(removeBtn);
        div.appendChild(meta);
        previewGrid.appendChild(div);
      });
    }

    function trimNewFilesToSlots() {
      const slots = remainingSlots();
      const files = Array.from(dt.files);
      if (files.length <= slots) return;

      const keep = files.slice(0, slots);
      while (dt.items.length) dt.items.remove(0);
      keep.forEach(f => dt.items.add(f));
      fileInput.files = dt.files;
      showError(`ì¶”ê°€ ê°€ëŠ¥í•œ ìŠ¬ë¡¯(${slots}ì¥)ì„ ì´ˆê³¼í•œ íŒŒì¼ì€ ìë™ìœ¼ë¡œ ì œì™¸í–ˆì–´ìš”.`);
      renderPreview();
    }

    delChks.forEach(c => c.addEventListener('change', () => {
      refreshStats();
      trimNewFilesToSlots();
    }));

    addBtn.addEventListener('click', () => {
      fileInput.value = '';
      fileInput.click();
    });

    fileInput.addEventListener('change', () => {
      showError('');
      const selected = Array.from(fileInput.files || []);
      if (selected.length === 0) return;

      const slots = remainingSlots();
      const keys = currentKeys();
      const err = [];

      for (const file of selected) {
        if (dt.files.length >= slots) {
          err.push(`ì¶”ê°€ ê°€ëŠ¥ ìŠ¬ë¡¯(${slots}ì¥) ì´ˆê³¼: ë” ì´ìƒ ì„ íƒí•  ìˆ˜ ì—†ì–´ìš”.`);
          break;
        }
        if (!isAllowedImage(file)) { err.push(`íƒ€ì… ë¯¸ì§€ì›: ${file.name}`); continue; }
        if (file.size > MAX_SIZE) { err.push(`5MB ì´ˆê³¼: ${file.name}`); continue; }

        const k = keyOf(file);
        if (keys.has(k)) { err.push(`ì´ë¯¸ ì„ íƒë¨: ${file.name}`); continue; }

        dt.items.add(file);
        keys.add(k);
      }

      fileInput.files = dt.files;
      if (err.length) showError(err.join('\n'));
      renderPreview();
    });

    document.getElementById('editForm').addEventListener('submit', () => {
      fileInput.files = dt.files;
    });

    refreshStats();
  })();
</script>

</body>
</html>
