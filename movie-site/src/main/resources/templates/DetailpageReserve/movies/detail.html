<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${movie.title}">영화 상세</title>

    <!-- Film Box 공통 헤더 스타일 -->
    <link rel="stylesheet" href="/Member/css/index.css" />

    <!-- 기존 CSS -->
    <link rel="stylesheet" th:href="@{/DetailpageReserve/css/style.css}"/>
    <script th:src="@{/Member/js/index.js}" defer></script>
    <script th:src="@{/DetailpageReserve/js/reserve-auth-guard.js}" defer></script>
</head>
<body class="reserve-body movie-detail-page">

<!-- Film Box 공통 헤더 -->
<div th:replace="fragments/header :: header('movies')"></div>

<main class="detail-layout movie-detail">
    <!-- 상단 뒤로가기 링크 -->
    <a th:href="@{/movies}" class="back-to-list">&larr; 영화 목록</a>

    <!-- ===== 영화 히어로 영역 ===== -->
    <section class="movie-hero">
        <div class="movie-hero__poster">
            <!-- DB 값: /DetailpageReserve/img/xxx.webp -->
            <img th:src="${movie.posterUrl}" alt="포스터" class="movie-poster"/>
        </div>

        <div class="movie-hero__content">
            <h1 th:text="${movie.title}" class="movie-title">영화 제목</h1>

            <div class="movie-meta">
                <span class="badge badge--rating" th:text="${movie.rating}">15세이상</span>
                <span class="meta-item meta-item--runtime">
                    <span class="meta-icon" aria-hidden="true">⏱</span>
                    <span th:text="${movie.runningTime}">128분</span>
                </span>
            </div>

            <div class="movie-chips">
                <span class="chip" th:text="${movie.genre}">장르</span>
            </div>

            <div class="synopsis">
                <h2 class="section-title">줄거리</h2>
                <p class="movie-description" th:text="${movie.description}">영화 줄거리 텍스트</p>
            </div>
        </div>
    </section>

    <!-- ===== 예고편 / 관련 영상 ===== -->
    <section class="trailer-section" th:if="${trailerIds != null and !#lists.isEmpty(trailerIds)}">
        <div class="section-head">
            <h2 class="section-title">예고편 / 관련 영상</h2>
        </div>

        <div class="trailer-grid">
            <div th:each="tid : ${trailerIds}" class="trailer-card">
                <div class="trailer-frame">
                    <iframe th:src="'https://www.youtube.com/embed/' + ${tid}"
                            title="trailer"
                            frameborder="0"
                            allowfullscreen>
                    </iframe>
                </div>
            </div>
        </div>
    </section>

    <!-- ===== 상영 정보 + 필터 ===== -->
    <section class="screening-section">
        <div class="section-head">
            <h2 class="section-title">상영 정보</h2>
        </div>

        <!-- 상영 일정 없을 때 -->
        <div class="no-screening" th:if="${#lists.isEmpty(screenings)}">
            등록된 상영 일정이 없습니다.
        </div>

        <!-- 필터 + 목록 (상영 일정 있을 때) -->
        <div th:unless="${#lists.isEmpty(screenings)}">
            <div class="screening-controls">
                <div class="control">
                    <div class="control-label">영화관 선택</div>
                    <div class="brand-buttons">
                        <button type="button" class="brand-filter active" data-brand="ALL">전체</button>
                        <button type="button" class="brand-filter" data-brand="CGV">CGV</button>
                        <button type="button" class="brand-filter" data-brand="롯데시네마">롯데시네마</button>
                        <button type="button" class="brand-filter" data-brand="메가박스">메가박스</button>
                    </div>
                </div>

                <div class="control">
                    <label class="control-label" for="branchSelect">지역 / 극장 선택</label>
                    <select id="branchSelect" class="select">
                        <option value="ALL">전체 지역</option>
                        <!-- 옵션은 아래 JS가 상영관 목록에서 자동 생성 -->
                    </select>
                </div>
            </div>

            <div class="screening-list" id="screeningList">
                <div class="screening-row"
                     th:each="screening : ${screenings}"
                     th:attr="data-theater=${screening.theaterName}">

                    <div class="screening-col screening-col--theater">
                        <span class="pin" aria-hidden="true"></span>
                        <div class="theater-name" th:text="${screening.theaterName}">CGV 강남점</div>
                    </div>

                    <div class="screening-col screening-col--time">
                        <div class="date" th:text="${#temporals.format(screening.screeningTime, 'M월 d일')}">1월 2일</div>
                        <div class="time" th:text="${#temporals.format(screening.screeningTime, 'HH:mm')}">23:00</div>
                    </div>

                    <div class="screening-col screening-col--seats">
                        <div class="seats">
                            <span th:text="${availableSeatsMap[screening.id]}">0</span>
                            <span class="muted">/</span>
                            <span th:text="${screening.totalSeats}">50</span>
                        </div>
                    </div>

                    <div class="screening-col screening-col--action">
                        <a th:if="${availableSeatsMap[screening.id] > 0}"
                           th:href="@{|/reserve/${screening.id}|}"
                           class="btn-reserve">
                            예매하기
                        </a>
                        <span th:if="${availableSeatsMap[screening.id] <= 0}" class="btn-soldout">
                            매진
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 아래 여백 -->
    <div class="page-spacer"></div>
</main>

<!-- ===== 상영 정보 필터 JS ===== -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rows = Array.from(document.querySelectorAll('.screening-row'));
        const branchSelect = document.getElementById('branchSelect');
        const brandButtons = Array.from(document.querySelectorAll('.brand-filter'));

        if (!rows.length || !branchSelect) return;

        // 지점 목록 중복 제거해서 select option 만들기
        const branchSet = new Set();
        rows.forEach(row => {
            const theater = row.dataset.theater || '';
            if (theater) branchSet.add(theater);
        });

        branchSet.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            branchSelect.appendChild(opt);
        });

        let currentBrand = 'ALL';
        let currentBranch = 'ALL';

        function applyFilter() {
            rows.forEach(row => {
                const theater = row.dataset.theater || '';

                // 브랜드는 극장 이름에 포함되는지만 체크 (CGV / 롯데시네마 / 메가박스)
                const brandMatch = (currentBrand === 'ALL') || theater.includes(currentBrand);
                const branchMatch = (currentBranch === 'ALL') || theater === currentBranch;

                row.style.display = (brandMatch && branchMatch) ? '' : 'none';
            });
        }

        brandButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                brandButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentBrand = btn.dataset.brand;
                applyFilter();
            });
        });

        branchSelect.addEventListener('change', () => {
            currentBranch = branchSelect.value;
            applyFilter();
        });
    });
</script>

<!-- 아래 여백 -->
<div style="height: 80px;"></div>
    <div id="siteFooter"></div>
    <script src="/common/footer.js" defer></script>
</body>
</html>