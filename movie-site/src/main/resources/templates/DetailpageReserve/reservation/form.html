<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>좌석 선택 및 예매</title>

    <!-- static/css/style.css -->
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
</head>
<body>

<div class="reserve-page">
    <h1>좌석 선택 및 예매</h1>

    <!-- 상단 정보 -->
    <div class="reserve-info">
        <p>
            <span class="info-label">영화</span>
            <span th:text="${screening.movie.title}"></span>
        </p>
        <p>
            <span class="info-label">극장</span>
            <span th:text="${screening.theaterName}"></span>
        </p>
        <p>
            <span class="info-label">상영 시간</span>
            <span th:text="${#temporals.format(screening.screeningTime, 'yyyy-MM-dd HH:mm')}"></span>
        </p>
	     <p>
	    <span class="info-label">잔여 좌석</span>
	    <span th:text="${availableSeats}"></span>
		</p>

    </div>

    <!-- 예매 폼 -->
    <form th:action="@{|/reserve/${screening.id}|}"
          method="post"
          onsubmit="return validateSeats();">

        <div class="form-row">
            <label>이름</label>
            <input type="text" name="name" required/>
        </div>

        <div class="form-row">
            <label>연락처</label>
            <input type="text" name="phone" required/>
        </div>

        <div class="form-row">
            <label>인원 수</label>
            <input type="number" id="count" name="count" min="1"
                   th:attr="max=${availableSeats}" required/>
        </div>

        <!-- 좌석 영역 -->
        <div class="seat-wrapper">
            <div class="screen-box">
                <div class="screen">SCREEN</div>

                <div class="seat-grid">
                    <div th:each="row : ${rows}" class="seat-row">
                        <div class="row-label" th:text="${row}"></div>

                        <div class="row-seats"
                             th:each="col : ${cols}"
                             th:with="seatId=${row + col}">
                            <button type="button"
                                    class="seat"
                                    th:id="${seatId}"
                                    th:data-seat="${seatId}"
                                    th:classappend="${#sets.contains(reservedSeats, seatId)} ? ' reserved' : ''"
                                    th:text="${#sets.contains(reservedSeats, seatId)} ? 'X' : col"
                                    th:disabled="${#sets.contains(reservedSeats, seatId)}">
                            </button>
                        </div>
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box available"></div>
                        <span>선택 가능</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box selected"></div>
                        <span>선택 좌석</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box reserved"></div>
                        <span>예약 완료</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 선택된 좌석 hidden -->
        <input type="hidden" id="selectedSeats" name="selectedSeats"/>

        <div class="actions">
            <button type="submit" class="btn-primary">예매하기</button>
        </div>

        <div class="back-link">
            <a th:href="@{|/movies/${screening.movie.id}|}">영화 상세로 돌아가기</a>
        </div>
    </form>
</div>

<script>
    const selected = new Set();

    // 예약된 좌석(reserved)이 아닌 버튼들만 클릭 가능
    document.querySelectorAll('.seat:not(.reserved)').forEach(btn => {
        btn.addEventListener('click', () => {
            const seat = btn.dataset.seat;

            if (selected.has(seat)) {
                selected.delete(seat);
                btn.classList.remove('selected');
            } else {
                selected.add(seat);
                btn.classList.add('selected');
            }

            document.getElementById('selectedSeats').value =
                Array.from(selected).join(',');
        });
    });

    function validateSeats() {
        const count = parseInt(document.getElementById('count').value || '0', 10);
        const seats = Array.from(selected);

        if (seats.length === 0) {
            alert('좌석을 선택해 주세요.');
            return false;
        }

        if (seats.length !== count) {
            alert('선택한 좌석 수와 인원 수가 같아야 합니다.');
            return false;
        }

        document.getElementById('selectedSeats').value = seats.join(',');
        return true;
    }
</script>

</body>
</html>
